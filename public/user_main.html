<html lang = "ru">
<title>CyberSec</title>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
<header>
<div class="header-container">
<div class = "logo">Курсы по информационной безопасности</div>
<div class = "logo username"><img src = "../images/image.png" class = "profile-pic"><span id = "header-username"></span><span class = "exit-btn">Выйти</span></div>
</div>
</header>
<body>
<div style = "margin-top: 3rem; margin-left: 4rem;">
<span class = "razdel_switch" id = "button_assigned_courses">Назначенные курсы</span>
<span class = "razdel_switch" id = "button_completed_courses">Завершенные курсы</span>
<span class = "razdel_switch" id = "button_learning_materials">Учебные материалы</span>
</div>
<hr style = "margin-top: 1.9rem;">
<section id = "assigned_courses" class = "section">
    
    <div id = "assigned_courses_container"></div>
</section>
<section id = "completed_courses" class = "section">
    
    <div id = "completed_courses_container"></div>
</section>
<section id = "learning_materials" class = "section">
    <input type = "text" placeholder="Введите информацию для поиска" class = "search-field" id = "search_field">
    <div id = "search_container" class = "search-container"></div>
    <div id = "learning_materials_container"></div>
</section>
</body>

<script>
    const url_params = new URLSearchParams(window.location.search);

    const username = url_params.get('username');
    document.getElementById('header-username').innerHTML = `${username}`;

    document.querySelector('.logo.username').addEventListener('mouseover', function(e) {
        e.preventDefault();
        let exit_btn = document.querySelector('.exit-btn');
        exit_btn.classList.add('active');
    });
    document.querySelector('.logo.username').addEventListener('mouseout', function(e) {
        e.preventDefault();
        let exit_btn = document.querySelector('.exit-btn');
        exit_btn.classList.remove('active');
    });
    const exit_btn = document.querySelector('.exit-btn');
    exit_btn.addEventListener('click', function () {
        window.location.replace('/');
    });

    const button_assigned_courses = document.getElementById('button_assigned_courses');
    const button_completed_courses = document.getElementById('button_completed_courses');
    const button_learning_materials = document.getElementById('button_learning_materials');
    const assigned_courses = document.getElementById('assigned_courses');
    const completed_courses = document.getElementById('completed_courses');
    const learning_materials = document.getElementById('learning_materials');
    
    let update1 = null;
    let update2 = null;
    let update3 = null;
    button_assigned_courses.addEventListener('click', function(e) {
        e.preventDefault();
        completed_courses.classList.remove('active');
        learning_materials.classList.remove('active');
        assigned_courses.classList.add('active');
        button_completed_courses.classList.remove('active');
        button_learning_materials.classList.remove('active');
        button_assigned_courses.classList.add('active');
        update1 = setInterval(updateAssignedCourses(username), 5000);
        clearInterval(update2);
        clearInterval(update3);
    });
    button_completed_courses.addEventListener('click', function(e) {
        e.preventDefault();
        assigned_courses.classList.remove('active');
        learning_materials.classList.remove('active');
        completed_courses.classList.add('active');
        button_assigned_courses.classList.remove('active');
        button_learning_materials.classList.remove('active');
        button_completed_courses.classList.add('active');
        update2 = setInterval(updateCompletedCourses(username), 5000);
        clearInterval(update1);
        clearInterval(update3);
    });
    button_learning_materials.addEventListener('click', function(e) {
        e.preventDefault();
        assigned_courses.classList.remove('active');
        completed_courses.classList.remove('active');
        learning_materials.classList.add('active');
        button_assigned_courses.classList.remove('active');
        button_completed_courses.classList.remove('active');
        button_learning_materials.classList.add('active');
        update3 = setInterval(updateLearningMaterials(),5000);
        clearInterval(update1);
        clearInterval(update2);
    });

    const search_field = document.getElementById('search_field');
    search_field.addEventListener('focus', async (e) => {
        e.preventDefault();
        document.getElementById('learning_materials_container').classList.add('hidden');
        document.getElementById('search_container').classList.add('active');
    });
    search_field.addEventListener('blur', async (e) => {
        e.preventDefault();
        document.getElementById('learning_materials_container').classList.remove('hidden');
        document.getElementById('search_container').classList.remove('active');
    });
    search_field.addEventListener('input', async function(e) {
        e.preventDefault();
        let search_query = search_field.value;
        try {
            const params = new URLSearchParams({
                search: search_query  
            });
            const response = await fetch(`/search?${params}`);
            const data = await response.json();
            console.log('Проверка', data);
            const search_div = document.getElementById('search_container');
            search_div.innerHTML = ``;
            data.forEach(el => {
                search_div.insertAdjacentHTML('beforeend', `<div data-search = "${el.filename}" class = "search_el">
                    <span><span class = "additional">Источник: </span>${el.filename.substring(0,el.filename.lastIndexOf('.'))}</span>
                    <span><span class = "additional">Найдено: </span>${el.innerData}...</span>
                </div>`);
                console.log(document.querySelector(`[data-search = "${el.filename}"]`));
                document.querySelector(`[data-search = "${el.filename}"]`).addEventListener('click', async function(e) {
                    e.preventDefault();
                    console.log('Нажал на найденное')
                    getPage(el.directory,el.filename);
                });
            });
        } catch (error) {
            console.error('Не удалось получить информацию', error);
        }
    });

    async function updateAssignedCourses(username) {    
    try {
        const params = new URLSearchParams({
            user: username  
        });
        const response = await fetch(`/get-info-assigned_courses?${params}`);
        const data = await response.json();        
        const courses_div = document.getElementById('assigned_courses_container');
        var str = "";
        data.forEach(item => str = str + `<div class = "list-element assigned_grid" value = '${item}'>
            <span class = 'name'>${item}</span><span class = "additional">Срок окончания: 19 декабря 2025 года</span>
                </div>`);
        courses_div.innerHTML = `<div style = "display: grid; gap: 1.1rem;">${str}</div>`;
        const links = document.querySelectorAll('.list-element');
        links.forEach(link => {
            link.addEventListener('click', async function() {
                try {
                    const pparams = new URLSearchParams({
                        user: username,
                        course: link.getAttribute('value')
                    });
                    const response = await fetch(`/redirect_to_course?${pparams}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    console.log(pparams);
                    const data = await response.json();
                    setTimeout(() => {window.location.href = data.url;},1000);
                } catch (error) {
                    console.error('Вот такая ошибка', error);
                }
            });
        });
        //return Array.isArray(data) ? data : [data];
                

    } catch (error) {
        console.log(error);
        //return [];
    }
}
async function updateCompletedCourses(username) {    
    try {
        const params = new URLSearchParams({
            user: username  
        });
        const response = await fetch(`/get-info-completed_courses?${params}`);
        const data = await response.json();
        console.log(data);        
        const courses_div = document.getElementById('completed_courses_container');
        var str = "";
        data.forEach(item => str = str + `<div class = "list-element completed_grid">
            <span class = 'name'>${item.course_name}</span><span class = "additional">Дата завершения: ${item.timestamp}</span>
            <span class = "additional">Время прохождения: ${item.timer}</span><span class = "additional">Результат: ${item.correct} правильных ответов из ${item.from}</span>
                </div>`);
        courses_div.innerHTML = `<div style = "display: grid; gap: 1.1rem;">${str}</div>`;
        const links = document.querySelectorAll('.list-element');
        links.forEach(link => {
            link.addEventListener('click', async function() {
                try {
                    const pparams = new URLSearchParams({
                        user: username,
                        course: link.getAttribute('value')
                    });
                    const response = await fetch(`/redirect_to_course?${pparams}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'text/html'
                        }
                    });
                    console.log(pparams);
                    const data = await response;
                } catch (error) {
                    console.error('Вот такая ошибка', error);
                }
            });
        });
        //return Array.isArray(data) ? data : [data];
                

    } catch (error) {
        console.log(error);
        //return [];
    }
}
async function updateLearningMaterials() {    
    try {
        const params = new URLSearchParams({
            object: 'directories'  
        });
        const response = await fetch(`/get-info-learning_materials?${params}`);
        const data = await response.json();        
        const learn_div = document.getElementById('learning_materials_container');
        var str = "";
        data.forEach(item => str = str + `<div data-name = "${item}" data-status = "closed" class = "directories">
            <span class = "h3-element">${item}</span>
            <img src = '../images/caret-down-thin.svg' width = "32" height = "20" data-arrowname = "${item}" class = "arrow">
            </div>
            <div data-listname = "${item}" class = "directory_container"></div>`);
        learn_div.innerHTML = `<div style = "display:grid; gap: 10px;">${str}</div>`;
        const directories = document.querySelectorAll('.directories');
        directories.forEach(directory => {
            directory.addEventListener('click', async function(e) {
                e.preventDefault();
                const directory_container = document.querySelector(`[data-listname = "${directory.dataset.name}"]`);
                if (directory.dataset.status === "closed") {
                    document.querySelector(`[data-arrowname = "${directory.dataset.name}"]`).classList.add('rotated');
                    console.log('Clicked');
                    try {
                        let pparams = new URLSearchParams({
                            object: 'files',
                            where: directory.dataset.name 
                        });
                        const response2 = await fetch(`/get-info-learning_materials?${pparams}`);
                        var data2 = await response2.json();
                        console.log('Вот список',data2);
                    } catch (error) {
                        console.error('Не удалось получить файлы в каталоге', error);
                    }
                    
                    data2.forEach(item => {
                        directory_container.insertAdjacentHTML('beforeend', `<div data-name = "${item}" class = "files">
                        <span>${item.substring(0,item.lastIndexOf('.'))}</span></div>`);
                        document.querySelector(`[data-name = "${item}"]`).addEventListener('click', function(e) {
                            e.preventDefault();
                            getPage(directory.dataset.name,item);
                        });
                    });
                    directory_container.classList.add("active");
                    directory.dataset.status = "opened";
                } else {
                    document.querySelector(`[data-arrowname = "${directory.dataset.name}"]`).classList.remove('rotated');
                    directory_container.innerHTML = ``;
                    directory_container.classList.remove("active");
                    directory.dataset.status = "closed";
                }
            });
        });
    } catch (error) {
        console.error('Вот такая ошибка', error);
    }
}
        
        //return Array.isArray(data) ? data : [data];
                

async function getPage(directory_name, page_name) {
    console.log(`getPage(${directory_name}, ${page_name})`);
    try {
        let pparams = new URLSearchParams({
            object: 'file',
            where: directory_name,
            which: page_name 
        });
        const response = await fetch(`/get-info-learning_materials?${pparams}`);
        var page = await response.text();
        console.log(response.status, response);
        const blob = new Blob([page], {type: 'text/html'});
        const blobUrl = URL.createObjectURL(blob);
        const newWindow = window.open(blobUrl, '_blank');
        newWindow?.addEventListener('load', () => {
            setTimeout(() => URL.revokeObjectURL(blobUrl), 1000)
        });
    } catch (error) {
        console.error('Не удалось получить страницу', error);
    }
    
} 

async function sliceExt(filename) {
    return;
}

</script>

</html>