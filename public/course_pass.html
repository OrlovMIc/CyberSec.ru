<html lang = "ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
<div id = "container"></div>
<div class = "question_navi_panel">
<button id = "back" class = "question_navi_btn">Назад</button>
<button id = "next" class = "question_navi_btn">Вперед</button>
<span id = "timer">0:00</span>
<button id = "finish" class = "question_navi_btn">Завершить</button>
</div>
</body>

<script>
const urlParams = new URLSearchParams(window.location.search);
const user = urlParams.get('user');
const course = urlParams.get('course');
let currentQuestion = 0;
let questionForms = [];
let test_Data;
downloadCourse()
.then(testData => {
    buildTest(testData);
    test_Data = testData;
});

updateTimer();

const back = document.getElementById('back');
const next = document.getElementById('next');
const finish = document.getElementById('finish');
back.classList.add('hidden');
finish.classList.add('hidden');
back.addEventListener('click', function(e) {
    e.preventDefault();
    next.classList.remove('hidden');
    questionForms[currentQuestion].classList.remove('active');
    if (currentQuestion === 1) {
        back.classList.add('hidden');
    }
    currentQuestion--;
    questionForms[currentQuestion].classList.add('active');
});
next.addEventListener('click', function(e) {
    e.preventDefault();
    back.classList.remove('hidden');
    questionForms[currentQuestion].classList.remove('active');
    currentQuestion++;
    if (currentQuestion === questionForms.length - 1) {
        next.classList.add('hidden');
        finish.classList.remove('hidden');
    }
    questionForms[currentQuestion].classList.add('active');
});

finish.addEventListener('click', function(e) {
    e.preventDefault();
    saveData(test_Data);
})

async function downloadCourse() {
    try {
        const params = new URLSearchParams({
            username: user,
            course_to_pass: course   
        });
        const response = await fetch(`/get-course?${params}`);
        const data = await response.json();
        return await data;       
    } catch (error) {
        console.error('Загрузка файлов не удалась', error);
        return [];
    }
}

async function buildTest(testData) {
    let id = 0;
    const container = document.getElementById('container');
    Object.values(testData.questions).forEach(question => {
        id++;
        const questionForm = document.createElement('div');
        questionForm.className = "question";
        let htmlText = ``;
        switch (question.answer_type) {
            case 'choicemany':
                Object.keys(question.answers).forEach(answer => {
                    htmlText = htmlText + `<div><input type="checkbox" class = "answer n${question.id}">${answer}</div>`; 
                });
                break;
            case 'choiceone':
                Object.keys(question.answers).forEach(answer => {
                    htmlText = htmlText + `<div><input type="radio" name = "radiogroup" class = "answer n${question.id}">${answer}</div>`; 
                });
                break;
            case 'choicetext':
                Object.keys(question.answers).forEach(answer => {
                    htmlText = htmlText + `<div><input type="textarea" required placeholder = "Введите ответ" class ="answer text n${question.id}"></div>`; 
                });

        }
        questionForm.innerHTML = `<h3 style = "margin-bottom: 3rem;">${id}. ${question.question}</h3>${htmlText}`;
        questionForms.push(questionForm);
        container.appendChild(questionForm);

    });

    questionForms[0].classList.add("active");
}

async function saveData(testData) {
    const save_data = [];
    let index = 1;
    questionForms.forEach(questionForm => {
        let answers = document.querySelectorAll(`.n${index}`);
        if (answers[0].type != 'text') {
            answers = Array.from(answers).map(answer => answer.checked);
        } else {
            answers = answers[0].value;
        }
        console.log('Вот тута ', answers);
        save_data.push({
            id: index,
            answers
        });
        index++;
    });
    console.log(save_data);
    try {
        const response = await fetch('/check-results', {
            method: 'POST', 
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                course: course,
                user: user,
                timer: document.getElementById('timer').innerHTML,
                results: save_data
            })
        });
        const data = await response.json();
        setTimeout(() => {window.location.replace(data.url);},1000);
    
    } catch (error) {
        console.error('Не удалось отправить результаты', error);
    }

}

async function updateTimer() {
    let minutes = 0;
    let seconds = 0;
    const timer = document.getElementById('timer');
    setInterval(function () {
        seconds++;
        if (seconds === 60) {
            seconds = 0;
            minutes++;
        }
        if (String(seconds).length === 1) {
                seconds = '0' + String(seconds);
        }
        timer.innerHTML = `${minutes}:${seconds}`;
    }, 1000);
}

</script>

</html>